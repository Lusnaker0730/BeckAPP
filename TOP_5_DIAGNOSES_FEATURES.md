# 前五大診斷 - 高級功能說明

## 📊 功能總覽

我們為「前五大診斷」圖表添加了 4 個強大的新功能，讓數據分析更加深入和靈活。

---

## ✨ 功能 1：百分比顯示

### 📈 功能描述
- 在每個柱狀圖上直接顯示百分比（白色粗體文字）
- 滑鼠懸停時顯示詳細信息（人次 + 百分比）
- 自動計算每個診斷佔總數的比例

### 🎯 使用場景
```
場景：快速了解診斷分布
操作：查看圖表
結果：立即看到 "Viral sinusitis" 佔 27.1%
```

### 💡 技術實現
- **前端**：使用 `chartjs-plugin-datalabels` 插件
- **後端**：計算並返回 `percentages` 數組
- **顏色**：白色文字，在深色背景上清晰可見

### 📷 視覺效果
```
柱狀圖頂部顯示：
┌─────┐
│27.1%│ ← 白色百分比
└─────┘
```

---

## 📊 功能 2：趨勢箭頭（年度對比）

### 📈 功能描述
- 自動比較當前年份區間與上一年份區間
- 顯示趨勢指標：
  - ↗️ **上升**（紅色）：增加超過 5%
  - ↘️ **下降**（綠色）：減少超過 5%
  - → **穩定**（灰色）：變化在 ±5% 內
  - ✨ **新增**（藍色）：上一期間沒有此診斷

### 🎯 使用場景
```
場景：追蹤疾病趨勢
操作：選擇年份區間 2020-2024
結果：看到 "Acute viral pharyngitis" ↗️ 上升 45.3%
說明：與 2015-2019 年相比，該診斷人數大幅增加
```

### 💡 趨勢計算邏輯
```python
當前區間：2020-2024（5 年）
上一區間：2015-2019（5 年）← 自動計算

變化率 = ((當前人次 - 上一期人次) / 上一期人次) × 100%

if 變化率 > 5%:   趨勢 = "上升" ↗️
elif 變化率 < -5%: 趨勢 = "下降" ↘️
else:              趨勢 = "穩定" →
```

### 📷 視覺效果
```
趨勢分析面板：
┌──────────────────────────────────────┐
│ 趨勢分析 (相比上一期間)              │
├──────────────────────────────────────┤
│ ↗️  Viral sinusitis         上升 15.3% │
│ ↘️  Acute viral pharyngitis 下降 8.7%  │
│ →  Acute bronchitis         穩定       │
│ ✨  Normal pregnancy         新增       │
└──────────────────────────────────────┘
```

---

## 💾 功能 3：導出功能

### 📈 功能描述
- **CSV 格式**：Excel 可直接打開，支持中文（BOM）
- **JSON 格式**：結構化數據，包含完整元數據
- 包含所有信息：排名、診斷名稱、人次、百分比、趨勢、變化率

### 🎯 使用場景

#### 場景 A：導出給管理層
```
需求：董事會需要 2023 年度診斷報告
操作：
1. 選擇年份：2023-2023
2. 點擊「📊 CSV」按鈕
3. 文件名：前五大診斷_2023-2023_2025-10-29.csv
結果：Excel 表格，可直接用於 PowerPoint
```

#### 場景 B：數據分析
```
需求：研究團隊需要原始數據
操作：
1. 選擇年份：2020-2024
2. 點擊「📄 JSON」按鈕
3. 文件名：前五大診斷_2020-2024_2025-10-29.json
結果：JSON 格式，可用於 Python/R 分析
```

### 💡 導出格式

#### CSV 格式示例
```csv
排名,診斷,人次,百分比,趨勢,變化率
1,"Viral sinusitis (disorder)",105,27.1%,上升,15.3%
2,"Acute viral pharyngitis (disorder)",68,17.5%,下降,8.7%
3,"Acute bronchitis (disorder)",45,11.6%,穩定,0%
4,"Normal pregnancy",35,9.0%,新增,100.0%
5,"Body mass index 30+ - obesity (finding)",34,8.8%,上升,22.1%
```

#### JSON 格式示例
```json
{
  "metadata": {
    "exportDate": "2025-10-29T08:30:00.000Z",
    "yearRange": "2020-2024",
    "etlJobId": "all",
    "total": 387
  },
  "diagnoses": [
    {
      "rank": 1,
      "diagnosis": "Viral sinusitis (disorder)",
      "count": 105,
      "percentage": 27.1,
      "trend": {
        "direction": "up",
        "change": 15.3
      }
    },
    ...
  ]
}
```

### 🔒 文件命名規則
```
格式：前五大診斷_{年份區間}_{導出日期}.{格式}

示例：
- 前五大診斷_2020-2024_2025-10-29.csv
- 前五大診斷_2015-2019_2025-10-29.json
```

---

## 🔄 功能 4：對比視圖

### 📈 功能描述
- 啟用對比模式，並排顯示兩個年份區間的診斷數據
- 期間 A（藍色系）vs 期間 B（橙色系）
- 獨立的年份選擇器
- 顯示各期間總人次

### 🎯 使用場景

#### 場景 A：疫情前後對比
```
研究目標：分析 COVID-19 對診斷模式的影響

操作步驟：
1. 點擊「啟用對比模式」☑️
2. 期間 A：2020-2024（疫情期間）
3. 期間 B：2015-2019（疫情前）
4. 觀察兩個圖表

發現：
- 呼吸道疾病在期間 A 增加 45%
- 預防性檢查在期間 A 減少 30%
- 慢性病管理模式改變
```

#### 場景 B：長期趨勢分析
```
研究目標：10 年間疾病模式變化

操作步驟：
1. 啟用對比模式
2. 期間 A：2020-2024
3. 期間 B：2010-2014
4. 分析診斷排名變化

洞察：
- 某些疾病從前五大消失（預防成功）
- 新的健康問題出現（老齡化、生活方式）
- 醫療技術進步影響診斷準確性
```

### 💡 視覺對比

#### 單一視圖（預設）
```
┌─────────────────────────────┐
│   前五大診斷                │
│   2020 - 2024              │
│                             │
│   [柱狀圖]                  │
│                             │
│   趨勢分析                  │
└─────────────────────────────┘
```

#### 對比視圖
```
┌────────────────┬────────────────┐
│ 期間 A         │ 期間 B         │
│ 2020-2024     │ 2015-2019     │
│               │               │
│ [藍色柱狀圖]  │ [橙色柱狀圖]  │
│               │               │
│ 總計: 387     │ 總計: 295     │
└────────────────┴────────────────┘
```

### 🎨 顏色主題

**期間 A（藍色系）**
- 主色：`rgba(37, 99, 235, 0.8)` - 藍色
- 次色：綠色、黃色、紅色、紫色
- 背景：淺藍色 `#eff6ff`

**期間 B（橙色系）**
- 主色：`rgba(234, 88, 12, 0.8)` - 橙色
- 次色：紫色、粉色、天藍色、綠色
- 背景：淺橙色 `#fff7ed`

---

## 🔧 技術架構

### 後端 API 更新

#### 端點：`GET /api/analytics/top-conditions`

**新增參數：**
```python
start_year: int  # 開始年份（2000-2100）
end_year: int    # 結束年份（2000-2100）
```

**返回格式：**
```json
{
  "labels": ["診斷1", "診斷2", ...],
  "values": [105, 68, ...],
  "percentages": [27.1, 17.5, ...],
  "total": 387,
  "trends": [
    {"direction": "up", "change": 15.3},
    {"direction": "down", "change": -8.7},
    ...
  ]
}
```

**趨勢計算邏輯：**
```python
# 計算上一期間
year_span = end_year - start_year + 1
prev_start_year = start_year - year_span
prev_end_year = start_year - 1

# 比較兩個期間的數據
change_percent = ((current - previous) / previous) * 100

# 判斷趨勢
if change_percent > 5:   → "up"
elif change_percent < -5: → "down"
else:                     → "stable"
```

### 前端組件更新

#### 新增狀態
```javascript
const [comparisonMode, setComparisonMode] = useState(false);
const [compareStartYear, setCompareStartYear] = useState(2015);
const [compareEndYear, setCompareEndYear] = useState(2019);
const [compareTopConditions, setCompareTopConditions] = useState(null);
```

#### 新增函數
```javascript
exportToCSV()   // 導出 CSV 格式
exportToJSON()  // 導出 JSON 格式
```

#### 新增依賴
```json
{
  "chartjs-plugin-datalabels": "^2.2.0"
}
```

---

## 📋 使用指南

### 基本操作

#### 1. 查看百分比
```
直接查看圖表 → 柱狀圖上顯示百分比
滑鼠懸停   → 顯示詳細信息（人次 + 百分比）
```

#### 2. 分析趨勢
```
選擇年份區間 → 自動計算趨勢
查看圖表下方 → 趨勢分析面板
觀察箭頭顏色 → 快速判斷變化方向
```

#### 3. 導出數據
```
點擊「📊 CSV」  → 下載 Excel 可讀格式
點擊「📄 JSON」 → 下載結構化數據
```

#### 4. 對比分析
```
點擊「啟用對比模式」 → 顯示年份選擇器
設定兩個期間        → 自動加載數據
並排查看圖表        → 直觀對比差異
```

### 進階技巧

#### 技巧 1：疫情影響分析
```
1. 啟用對比模式
2. 期間 A：2020-2022（疫情高峰）
3. 期間 B：2017-2019（疫情前）
4. 重點關注呼吸道疾病變化
```

#### 技巧 2：季節性分析
```
1. 不啟用對比模式
2. 選擇單一年份：2023-2023
3. 觀察趨勢箭頭（與 2022 比較）
4. 導出 CSV 進行更細緻分析
```

#### 技巧 3：長期趨勢追蹤
```
1. 啟用對比模式
2. 期間 A：2020-2024（最近 5 年）
3. 期間 B：2010-2014（10 年前）
4. 分析疾病譜的演變
```

---

## 🎯 實際應用案例

### 案例 1：醫院年度報告
```
背景：醫院需要準備年度健康報告

步驟：
1. 選擇年份：2024-2024
2. 查看前五大診斷及百分比
3. 點擊「📊 CSV」導出
4. 在 PowerPoint 中使用數據
5. 引用趨勢分析說明年度變化

結果：
✅ 清晰的數據可視化
✅ 專業的 Excel 表格
✅ 趨勢分析支持決策
```

### 案例 2：公共衛生研究
```
背景：研究疫情對社區健康的影響

步驟：
1. 啟用對比模式
2. 期間 A：2020-2021（疫情期）
3. 期間 B：2018-2019（疫情前）
4. 對比診斷模式變化
5. 點擊「📄 JSON」導出原始數據
6. 使用 Python 進行深度分析

發現：
✅ 呼吸道疾病增加 67%
✅ 慢性病追蹤減少 23%
✅ 心理健康問題上升 89%
```

### 案例 3：醫療資源規劃
```
背景：規劃未來 5 年的醫療資源配置

步驟：
1. 分析過去 10 年趨勢
   - 期間 A：2015-2019
   - 期間 B：2020-2024
2. 識別上升趨勢的疾病
3. 導出完整數據進行預測
4. 基於趨勢分配資源

決策依據：
✅ 數據驅動的資源分配
✅ 預測未來健康需求
✅ 優化醫療服務效率
```

---

## 🚀 效能優化

### 快取機制
```python
@cache_result(expire_seconds=600, key_prefix="top_conditions")
```
- 快取時間：10 分鐘
- 減少資料庫查詢
- 提升響應速度

### 資料庫優化
- 使用索引：`onset_datetime`, `code_text`, `job_id`
- 分組查詢優化
- 限制返回數量（limit=5）

---

## 📊 數據來源

### FHIR Condition 資源
```sql
SELECT 
  code_text,
  COUNT(*) as count,
  onset_datetime
FROM conditions
WHERE onset_datetime BETWEEN ? AND ?
GROUP BY code_text
ORDER BY count DESC
LIMIT 5
```

### 趨勢計算查詢
```sql
-- 當前期間
SELECT COUNT(*) FROM conditions
WHERE code_text = ?
  AND onset_datetime BETWEEN current_start AND current_end

-- 上一期間
SELECT COUNT(*) FROM conditions
WHERE code_text = ?
  AND onset_datetime BETWEEN prev_start AND prev_end
```

---

## 🔐 權限要求

所有功能都需要身份驗證：
```python
current_user: dict = Depends(get_current_user)
```

支持的角色：
- ✅ **Admin**：完整訪問權限
- ✅ **Engineer**：完整訪問權限
- ✅ **Viewer**：只讀權限（未來可擴展）

---

## 🐛 故障排除

### 問題 1：百分比不顯示
```
原因：chartjs-plugin-datalabels 未安裝
解決：npm install chartjs-plugin-datalabels
```

### 問題 2：趨勢顯示「無」
```
原因：年份區間太早，沒有上一期間數據
解決：選擇 2005 年以後的年份區間
```

### 問題 3：導出文件中文亂碼
```
原因：CSV 未包含 BOM
解決：已修復，導出時自動添加 BOM ('\uFEFF')
```

### 問題 4：對比模式圖表重疊
```
原因：瀏覽器窗口過小
解決：使用較大的顯示器或調整瀏覽器窗口大小
```

---

## 📈 未來擴展

### 計劃中的功能

#### 1. PDF 報告導出
```
功能：一鍵生成完整的 PDF 診斷報告
包含：圖表、趨勢分析、統計數據
```

#### 2. 電子郵件分享
```
功能：直接通過郵件發送報告
收件人：管理層、研究團隊
```

#### 3. 自動化報警
```
功能：診斷人次異常增長時自動通知
閾值：超過 50% 增長
```

#### 4. 多維度分析
```
功能：按年齡、性別、地區分組
對比：不同人群的診斷模式
```

#### 5. AI 預測
```
功能：基於歷史數據預測未來趨勢
模型：時間序列分析
```

---

## 📝 更新日誌

### v2.0.0 (2025-10-29)

#### 新增功能
- ✅ 百分比顯示在柱狀圖上
- ✅ 趨勢箭頭（年度對比分析）
- ✅ CSV/JSON 導出功能
- ✅ 對比視圖模式

#### 改進
- ✅ 後端 API 增強（percentages, trends）
- ✅ 快取機制優化
- ✅ UI/UX 改進

#### 技術債務
- ✅ 添加 chartjs-plugin-datalabels 依賴
- ✅ 重構圖表配置邏輯
- ✅ 優化資料庫查詢

---

## 🙏 致謝

感謝以下開源項目：
- **Chart.js** - 強大的圖表庫
- **chartjs-plugin-datalabels** - 數據標籤插件
- **React** - UI 框架
- **FastAPI** - 後端框架
- **PostgreSQL** - 資料庫

---

## 📞 技術支援

如有問題或建議，請聯繫：
- **GitHub Issues**: [提交問題](https://github.com/Lusnaker0730/BeckAPP/issues)
- **文檔**: 查看 `API_DOCUMENTATION.md`
- **測試**: 運行 `npm test` 和 `pytest`

---

## 📜 授權

本功能遵循項目主授權協議。

---

**開發完成日期**: 2025-10-29  
**版本**: 2.0.0  
**狀態**: ✅ 生產就緒  
**測試**: ✅ 通過所有測試  
**文檔**: ✅ 完整

